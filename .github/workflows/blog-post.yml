name: Latest blog post workflow
on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-readme-with-blog:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch and update blog post
        run: |
          # Fetch latest post from Atom feed
          FEED=$(curl -sL "https://www.polunzh.com/atom.xml")

          # Extract first entry
          TITLE=$(echo "$FEED" | grep -oP '(?<=<title>)[^<]+' | sed -n '2p')
          URL=$(echo "$FEED" | grep -oP '(?<=<link href=")[^"]+' | sed -n '3p')
          SUMMARY=$(echo "$FEED" | grep -oP '(?<=<summary type="html">).*?(?=</summary>)' | head -1 | sed 's/<[^>]*>//g' | head -c 200)

          # Create content block
          CONTENT="> **${TITLE}**
          >
          > ${SUMMARY}...
          >
          > ${URL}"

          # Update README
          awk -v content="$CONTENT" '
            /<!-- BLOG-POST-LIST:START -->/ { print; print content; found=1; next }
            /<!-- BLOG-POST-LIST:END -->/ { found=0 }
            !found { print }
          ' README.md > README.tmp && mv README.tmp README.md

      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git diff --quiet README.md || (git add README.md && git commit -m "Update latest blog post" && git push)
